{"version":3,"file":"HomeCommentService.js","sourceRoot":"./src/","sources":["Service/Home/Service/HomeCommentService.ts"],"names":[],"mappings":";;;AACA,mEAAgE;AAEhE,yDAAsD;AAEtD,MAAa,kBAAkB;IAK3B,gBAAgB,CAAC;IAEjB,MAAM,CAAC,IAAgB,EAAE,UAAsB;QAC3C,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC;QACjB,IAAI,CAAC,UAAU,GAAG,UAAU,CAAC;IACjC,CAAC;IAED,IAAI;QAEA,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,UAAU,EAAE,CAAC,GAAG,EAAE,GAAG,EAAE,EAAE;YAU1C,IAAI,IAAI,GAAmB,GAAG,CAAC,IAAI,CAAC,IAAI,CAAC;YACzC,IAAI,WAAW,GAAG,IAAI,CAAC;YACvB,IAAI,CAAC,IAAI,EAAE;gBACP,WAAW,GAAG,KAAK,CAAC;aACvB;YAED,IAAI,CAAC,IAAI,CAAC,IAAI,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,MAAM,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,EAAE;gBACxD,WAAW,GAAG,KAAK,CAAC;gBACpB,OAAO;aACV;YAED,IAAI,CAAC,WAAW,EAAE;gBACd,GAAG,CAAC,IAAI,CAAC;oBACL,KAAK,EAAE,CAAC,CAAC;iBACZ,CAAC,CAAA;gBACF,OAAO;aACV;YAED,IAAI,EAAE,GAAG,GAAG,CAAC,EAAE,CAAC;YAChB,IAAI,MAAM,GAAG,uBAAU,CAAC,WAAW,EAAE,CAAC;YAEtC,IAAI,IAAI,CAAC,UAAU,CAAC,YAAY,CAAC,EAAE,EAAE,IAAI,CAAC,MAAM,EAAE,MAAM,CAAC,EAAE;gBACvD,OAAO,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;gBACpB,GAAG,CAAC,IAAI,CAAC;oBACL,KAAK,EAAE,CAAC,CAAC;iBACZ,CAAC,CAAC;gBACH,OAAO;aACV;YAED,IAAI,KAAK,GAAiB;gBACtB,EAAE,EAAE,uBAAU,CAAC,SAAS;gBACxB,MAAM,EAAE,IAAI,CAAC,MAAM;gBACnB,IAAI,EAAE,IAAI,CAAC,IAAI;gBACf,IAAI,EAAE,IAAI,CAAC,IAAI;gBACf,OAAO,EAAE,IAAI,CAAC,OAAO;gBACrB,SAAS,EAAE,IAAI,CAAC,SAAS;gBACzB,MAAM,EAAE,MAAM;gBACd,EAAE,EAAE,EAAE;aACT,CAAC;YAEF,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,KAAK,CAAC,CAAC;YAElC,GAAG,CAAC,IAAI,CAAC;gBACL,KAAK,EAAE,CAAC;aACX,CAAC,CAAC;YAEH,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,CAAA;YACjB,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC,CAAA;QAEvB,CAAC,CAAC,CAAC;IACP,CAAC;CAEJ;AA5ED,gDA4EC","sourcesContent":["import { HttpServer } from \"jackwebutil\";\r\nimport { CommentDao } from \"../../../DB/Dao/Comment/CommentDao\";\r\nimport { CommentTable } from \"../../../DB/Table/CommentTable\";\r\nimport { DateHelper } from \"../../../Util/DateHelper\";\r\n\r\nexport class HomeCommentService {\r\n\r\n    http: HttpServer;\r\n    commentDao: CommentDao;\r\n\r\n    constructor() { }\r\n\r\n    Inject(http: HttpServer, commentDao: CommentDao) {\r\n        this.http = http;\r\n        this.commentDao = commentDao;\r\n    }\r\n\r\n    Init() {\r\n\r\n        this.http.PostListen(\"/Comment\", (req, res) => {\r\n\r\n            type CommentMessage = {\r\n                foodId: number,\r\n                star: number,\r\n                tags: string[],\r\n                content: string,\r\n                commenter: string,\r\n            }\r\n\r\n            let json: CommentMessage = req.body.data;\r\n            let isCheckData = true;\r\n            if (!json) {\r\n                isCheckData = false;\r\n            }\r\n\r\n            if (!json.tags || (json.tags.length == 0 && !json.content)) {\r\n                isCheckData = false;\r\n                return;\r\n            }\r\n\r\n            if (!isCheckData) {\r\n                res.json({\r\n                    state: -1\r\n                })\r\n                return;\r\n            }\r\n\r\n            let ip = req.ip;\r\n            let yymmdd = DateHelper.GetYYYYMMDD();\r\n\r\n            if (this.commentDao.HasCommented(ip, json.foodId, yymmdd)) {\r\n                console.log(\"当日已评\");\r\n                res.json({\r\n                    state: -2\r\n                });\r\n                return;\r\n            }\r\n\r\n            let table: CommentTable = {\r\n                id: CommentDao.currentId,\r\n                foodId: json.foodId,\r\n                star: json.star,\r\n                tags: json.tags,\r\n                content: json.content,\r\n                commenter: json.commenter,\r\n                yymmdd: yymmdd,\r\n                ip: ip,\r\n            };\r\n\r\n            this.commentDao.AddComment(table);\r\n\r\n            res.json({\r\n                state: 1\r\n            });\r\n\r\n            console.log(json)\r\n            console.log(req.ip)\r\n\r\n        });\r\n    }\r\n\r\n}"]}