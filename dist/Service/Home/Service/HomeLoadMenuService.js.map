{"version":3,"file":"HomeLoadMenuService.js","sourceRoot":"./src/","sources":["Service/Home/Service/HomeLoadMenuService.ts"],"names":[],"mappings":";;;AAeA,MAAa,mBAAmB;IAO5B,gBAAgB,CAAC;IAEjB,MAAM,CAAC,OAAgB,EAAE,OAAgB,EAAE,WAAwB,EAAE,IAAgB;QACjF,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACvB,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACvB,IAAI,CAAC,WAAW,GAAG,WAAW,CAAC;QAC/B,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC;IACrB,CAAC;IAED,IAAI;QAEA,IAAI,CAAC,IAAI,CAAC,UAAU,CAAC,UAAU,EAAE,CAAC,GAAG,EAAE,GAAG,EAAE,EAAE;YAC1C,IAAI,GAAG,GAAG,IAAI,CAAC,eAAe,EAAE,CAAC;YACjC,IAAI,CAAC,GAAG,EAAE;gBACN,OAAO;aACV;YACD,GAAG,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QAClB,CAAC,CAAC,CAAC;IAEP,CAAC;IAEO,eAAe;QAEnB,IAAI,GAAG,GAAY,IAAI,CAAC,WAAW,CAAC,gBAAgB,EAAE,CAAC;QAEvD,IAAI,GAAG,IAAI,IAAI,EAAE;YAEb,IAAI,IAAI,GAAc,IAAI,CAAC,OAAO,CAAC,YAAY,EAAE,CAAC;YAClD,IAAI,CAAC,IAAI,EAAE;gBACP,OAAO,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC;gBACvB,OAAO,IAAI,CAAC;aACf;YAED,IAAI,OAAO,GAAgB,EAAE,CAAC;YAC9B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,SAAS,CAAC,MAAM,EAAE,CAAC,IAAI,CAAC,EAAE;gBAC/C,IAAI,MAAM,GAAG,IAAI,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;gBAC/B,IAAI,IAAI,GAAG,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;gBACxC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;aACtB;YAED,GAAG,GAAG;gBACF,EAAE,EAAE,IAAI,CAAC,EAAE;gBACX,QAAQ,EAAE,IAAI,CAAC,QAAQ;gBACvB,OAAO,EAAE,OAAO;aACnB,CAAA;YAED,IAAI,CAAC,WAAW,CAAC,gBAAgB,CAAC,GAAG,CAAC,CAAC;SAE1C;QAED,OAAO,GAAG,CAAC;IAEf,CAAC;CAEJ;AA7DD,kDA6DC","sourcesContent":["import { HttpServer } from \"jackwebutil\";\r\nimport { FoodDao } from \"../../../DB/Dao/Food/FoodDao\";\r\nimport { MenuDao } from \"../../../DB/Dao/Menu/MenuDao\";\r\nimport { FoodTable } from \"../../../DB/Table/FoodTable\";\r\nimport { MenuTable } from \"../../../DB/Table/MenuTable\";\r\nimport { HomeMenuCao } from \"../Repository/HomeMenuCao\";\r\n\r\nexport type MenuDto = {\r\n\r\n    id: number;\r\n    yyyymmdd: string;\r\n    foodArr: FoodTable[];\r\n\r\n}\r\n\r\nexport class HomeLoadMenuService {\r\n\r\n    foodDao: FoodDao;\r\n    menuDao: MenuDao;\r\n    homeMenuCao: HomeMenuCao;\r\n    http: HttpServer;\r\n\r\n    constructor() { }\r\n\r\n    Inject(foodDao: FoodDao, menuDao: MenuDao, homeMenuCao: HomeMenuCao, http: HttpServer): void {\r\n        this.foodDao = foodDao;\r\n        this.menuDao = menuDao;\r\n        this.homeMenuCao = homeMenuCao;\r\n        this.http = http;\r\n    }\r\n\r\n    Init() {\r\n\r\n        this.http.PostListen(\"/GetMenu\", (req, res) => {\r\n            let dto = this.GetTodayMenuDto();\r\n            if (!dto) {\r\n                return;\r\n            }\r\n            res.json(dto);\r\n        });\r\n\r\n    }\r\n\r\n    private GetTodayMenuDto(): MenuDto {\r\n\r\n        let dto: MenuDto = this.homeMenuCao.GetCachedMenuDto();\r\n\r\n        if (dto == null) {\r\n\r\n            let menu: MenuTable = this.menuDao.GetTodayMenu();\r\n            if (!menu) {\r\n                console.log(\"不存在今日菜单\");\r\n                return null;\r\n            }\r\n\r\n            let foodArr: FoodTable[] = [];\r\n            for (let i = 0; i < menu.foodIdArr.length; i += 1) {\r\n                let foodId = menu.foodIdArr[i];\r\n                let food = this.foodDao.GetFood(foodId);\r\n                foodArr.push(food);\r\n            }\r\n\r\n            dto = {\r\n                id: menu.id,\r\n                yyyymmdd: menu.yyyymmdd,\r\n                foodArr: foodArr\r\n            }\r\n\r\n            this.homeMenuCao.SetCachedMenuDto(dto);\r\n\r\n        }\r\n\r\n        return dto;\r\n\r\n    }\r\n\r\n}"]}